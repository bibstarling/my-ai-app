# Bug Fixes - Google Sign-In Issues

## Bugs Reported
1. User was created in the database
2. Email was NOT saved in the database
3. User is not visible in the admin area

## Root Causes

### 1. Email Not Saved
**Problem**: The `/api/users/settings` endpoint was creating users without fetching and saving their email from Clerk.

**Location**: `app/api/users/settings/route.ts`

**What happened**: When a user signed in with Google, various components would call `/api/users/settings` to get/set preferences. If the user didn't exist, this endpoint would create them with only `clerk_id`, `content_language`, and `onboarding_completed` fields - **without the email**.

**Fix**: Updated all three HTTP methods (GET, POST, PATCH) to:
- Import `currentUser` from Clerk
- Fetch the user's email: `clerkUser?.emailAddresses?.[0]?.emailAddress`
- Include email in all insert/upsert operations

### 2. User Not Visible in Admin Area
**Problem**: The admin page was using the client-side Supabase client with incorrect RLS policies.

**Location**: `app/admin/page.tsx`

**What happened**: 
- Admin page used `@/lib/supabase` (anon key) instead of service role
- Direct client-side queries wouldn't work properly with secure RLS policies
- The RLS policies were overly permissive (USING (true)), which is a security risk

**Fix**: 
1. Updated admin page to use API endpoints instead of direct Supabase queries:
   - Fetch users via `/api/users/list` (already existed)
   - Update users via new `/api/users/update` endpoint
   - Check admin status via API instead of direct query
2. Created proper RLS policies in migration `20260211_fix_users_rls.sql`
3. Removed direct Supabase import from admin page

## Files Changed

### Modified
1. `app/api/users/settings/route.ts` - Fixed email capture in all methods
2. `app/admin/page.tsx` - Use API endpoints instead of direct queries

### Created
1. `app/api/users/sync-emails/route.ts` - Utility endpoint to backfill emails for existing users
2. `app/api/users/update/route.ts` - Admin endpoint to update user properties
3. `supabase/migrations/20260211_fix_users_rls.sql` - Proper RLS policies

## How to Apply Fixes

### Step 1: Apply the Database Migration
```bash
# This will fix the RLS policies
npm run apply-migrations
```

### Step 2: Fix Existing Users Without Emails
Once the app is running, call this endpoint as an admin:

```bash
# Via curl (replace with your auth token)
curl -X POST http://localhost:3000/api/users/sync-emails \
  -H "Content-Type: application/json"

# Or visit the URL in your browser while signed in as admin
# http://localhost:3000/api/users/sync-emails (make a POST request)
```

This endpoint will:
- Find all users without emails in the database
- Fetch their email from Clerk
- Update the database records

### Step 3: Verify
1. Check the admin area - users should now appear with emails
2. Have your friend sign out and sign in again to ensure everything works
3. Verify in the database that emails are being saved

## Security Improvements
- Fixed RLS policies to be properly restrictive
- Admin operations now use service role via API endpoints
- Client-side code can no longer directly modify user data

## Additional Notes
- The `/api/users/register` endpoint already had correct email handling, but it wasn't being called
- Most users are created via `/api/users/settings` on first use, which is why the bug affected new sign-ups
- The RLS policy fix improves security significantly - previous policies allowed anyone to read/modify all users
